# AGENT.md — Codex CLI Technical Instruction Base

> Goal: build and maintain a **React** project based on **TanStack Start**, better using **Clean Architecture** (adapters / entities / use-cases / repositories), fully **typed with strict TypeScript**, styled with **Tailwind CSS**, enforced by **ESLint**, data handled through **Supabase**, and **deployed via Netlify** using **FastAPI for back-end and fetching data from API**
> The agent must **create, modify, test, and deliver** code **without approximation** and with **automatic validation**.

---

## Scope & Deliverables

- **Framework**: [TanStack Start (React)](https://tanstack.com/start/latest) – routing, loaders/actions, RSC/SSR as needed.  
- **Architecture**: Clean Architecture  
  - **domain/**: `entities`, `value-objects`, `use-cases`, `ports` (interfaces).  
  - **adapters/**: `repositories`, `supabase`, `mappers`, `netlify`.  
  - **app/**: `ui` (web adapters), `routes`, `components`, `hooks`.  
- **Quality**: strict TS (`"strict": true`), ESLint, tests (Vitest), formatting (Prettier).  
- **UI**: Tailwind CSS.  
- **Data**: Supabase (auth, DB, storage if needed).  
- **CI/CD**: Build pipelines for staging, preview, and production via Netlify.  
- **DX**: NPM scripts, VS Code tasks, snippets, and SSR/RSC debugging support.

---

## Project Structure (source of truth)

```
/src                  # sources for all files (React, TanStack Start routes)
  /routes             # file-based routes
    __root.tsx        # main file for all routes, do not change this file except of real need
    index.tsx         # the file containing the function exported in react, also the primary file route of the website
    example.tsx       # will show the page /example
    api/              # contain API server createFileRoute
  /components         # all Reacts UI components, always based on Tailwind CSS
  /styles
  /providers
  /hooks
  /domain               # business core (pure TS, framework-agnostic)
    /[name]
        entities.ts
        valueObjects.ts
        useCases.ts
        ports.ts              
        errors.ts
  /adapters                # technical adapters implementations
    /auth-supabase          
    /billing-stripe       
    /db-supabase          
  /shared               # cross-cutting utilities (types, result/either, lib, zod schemas)
        container.ts    #function makeContainer() define all Repositories from adapters
  /tests                # unit and integration tests
/public
/.vscode
/.netlify
router.tsx              # Import the generated route tree
routeTree.gen.ts        # This file was automatically generated by TanStack Router. You should NOT make any changes in this file as it will be overwritten.
styles.css              # global CSS of the project
```

**Import Rules**:  
- `domain` only imports from `shared` (never `routes` or `adapters`).  
- `adapters` can import from `domain`
- `useCases` depend only on **ports** (interfaces); concrete implementations live in `adapters`.  
- `routes` consumes `useCases` via **dependency injection** (composition root).

---

## Project Initialization — Commands & Config Files

> The agent sets up all required files. Sensitive values are placed in `.env` and **never committed**.

## NPM Scripts (excerpt from `package.json`)

> The agent will use package.json

## Code style

- TypeScript strict mode with extensive type safety
- Framework-agnostic core logic separated from React/Solid bindings
- Type-safe routing with search params and path params

---

## Clean Architecture — Operational Rules

- **Entities / ValueObjects**: immutable, no external dependencies. Validate via constructors/factories. Avoid raw IDs – use VO types (`UserId` etc.).  
- **Use Cases**: pure TS *orchestrators*. Typed input/output DTOs, returning `Result<E, A>` (Either).  
- **Ports (domain/ports)**: interfaces for `Repository`, `Clock`, `Uuid`, `Logger`, etc.  
- **Adapters**: implements ports (e.g. SupabaseRepository, UuidNanoid), handles `DB <-> Entity` mapping.  
- **Routes (UI adapters)**: components/loaders/actions invoke use-cases, receive `Result`, and map to UI state.

---

## TanStack Start Integration (React)

- **Routing**: file-based under `src/routes`.  
  Use loaders/actions for data-fetching **through use-cases**. No direct Supabase calls in components.  
- **State**: prefer loader data + lightweight hooks. Avoid global state unless justified.  
- **Errors**: propagate `Result` to UI; show clean UX messages; log technical errors in infra.  
- **Styling**: utility-first via Tailwind; prefer headless components.

---

## Code Standards

- **TypeScript**: never use `any`. Prefer unions, discriminated unions, `Result`/`Either`.  
- **Validation**: handled in adapters (UI/API) using `zod`. Domain only receives validated types.  
- **Naming**: `Entity`, `*Id`, `*Repository`, `make*UseCase`, `toEntity`, `toDTO`.  
- **Tests**: >80% coverage on domain; infra tested with mocks or containers.  
- **UI**: pure, minimal components with accessibility (ARIA, focus).  
- **Commits**: Conventional Commits (`feat:`, `fix:`, `chore:`…) + PR checklist.

---

## Agent Execution Checklists

### Feature Creation
1. Create `entities.ts`/`valueObjects.ts` if needed.  
2. Define `ports.ts` for each new domain.  
3. Write the `useCases.ts` (full `Result` return type).  
4. Implement repository in `adapters` (map <-> entity).  
5. Add route/loader/action in `src/routes`.  
6. Build UI components + Tailwind styles.  
7. Write tests (domain unit, infra integration/mocked, route action).  
8. Update `CHANGELOG.md`.

### Quality & Release
- `npm run lint`  
- `npm run test`  
- Local build: `npm run build`  
- Prepare Netlify env vars  
- Deploy (preview → validation → production)

---

## Guardrails

- **Forbidden**: mixing domain logic with UI/adapters.  
- **Forbidden**: calling Supabase from `domain`.
- **Forbidden**: No provide explanation about why these changes.
- **Required**: every new flow goes through a tested `useCases.ts`.  
- **Required**: no uncaught exceptions in UI; always convert to `Result`/messages.  
- **Required**: no global state by default; justify its need.
- **Required**: always respond in french.
- **Required**: content file always in english.

---

### Notes
- Refer to **TanStack Start** docs for build/SSR nuances: (https://tanstack.com/start/latest)
- Never expose secrets — environment configuration must stay in Netlify env vars.  
- Aim for zero debt: if shortcuts are taken, open an issue with a fix plan.

**End of file.**
